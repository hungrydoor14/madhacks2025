<!DOCTYPE html>
<html>
<head>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>OCR Reader</title>
  <style>
    body { font-family: sans-serif; padding: 20px; }
    #preview { width: 100%; max-width: 350px; margin-top: 20px; }
    #result { white-space: pre-wrap; background: #eee; padding: 10px; margin-top: 20px; }
  </style>
</head>
<body>

<h2>Take Photo for OCR</h2>

<!-- Choose File Button -->
<input type="file" id="filePicker" accept="image/*" style="display:none;">
<button id="chooseFileBtn">Choose File</button>

<!-- Open Camera Button -->
<input type="file" id="cameraPicker" accept="image/*" capture="camera" style="display:none;">
<button id="cameraBtn">Open Camera</button>

<button id="uploadBtn" disabled>Upload & Read</button>

<img id="preview">
<pre id="result"></pre>

<button id="speakBtn" style="display:none;">Read aloud WIP STILL NOT WORKING</button>

<script>
let selectedFile = null;

async function checkCamera() {
  if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
    document.getElementById("cameraBtn").style.display = "none";
    return;
  }

  try {
    const stream = await navigator.mediaDevices.getUserMedia({ video: true });
    stream.getTracks().forEach(t => t.stop());
  } catch (err) {
    document.getElementById("cameraBtn").style.display = "none";
  }
}
checkCamera();

// ---- Choose file from storage ----
document.getElementById("chooseFileBtn").onclick = () => {
  document.getElementById("filePicker").click();
};

document.getElementById("filePicker").onchange = (e) => {
  selectedFile = e.target.files[0];
  document.getElementById("preview").src = URL.createObjectURL(selectedFile);
  document.getElementById("uploadBtn").disabled = false;
};

// ---- Open camera ----
document.getElementById("cameraBtn").onclick = () => {
  document.getElementById("cameraPicker").click();
};

document.getElementById("cameraPicker").onchange = (e) => {
  selectedFile = e.target.files[0];
  document.getElementById("preview").src = URL.createObjectURL(selectedFile);
  document.getElementById("uploadBtn").disabled = false;
};

// ---- Upload to Flask ----
document.getElementById("uploadBtn").onclick = async () => {
  if (!selectedFile) return alert("No image selected!");

  const formData = new FormData();
  formData.append("photo", selectedFile);

  const res = await fetch("/ocr", { method: "POST", body: formData });
  const data = await res.json();

  document.getElementById("result").textContent = data.text;
  document.getElementById("speakBtn").style.display = "block";
};

// ---- Read aloud ----
document.getElementById("speakBtn").onclick = () => {
  const text = document.getElementById("result").textContent;
  speechSynthesis.speak(new SpeechSynthesisUtterance(text));
};
</script>

</body>
</html>
